version: "3.9"

services:
  zabbix-server:
    image: zabbix/zabbix-server-pgsql@sha256:66de4a9604305f02305c2403a5458ca08ad0ece4a2529863ed2ebfa8bb7eb522
    container_name: zabbix-server
    environment:
      DB_SERVER_HOST: ${DB_SERVER_HOST}
      ZBX_LOG_LEVEL: ${ZBX_LOG_LEVEL}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      ZBX_CACHESIZE: ${ZBX_CACHESIZE}
      ZBX_HISTORYCACHESIZE: ${ZBX_HISTORYCACHESIZE}
      ZBX_TRENDCACHESIZE: ${ZBX_TRENDCACHESIZE}
      ZBX_VALUECACHESIZE: ${ZBX_VALUECACHESIZE}
      ZBX_STARTPOLLERS: ${ZBX_STARTPOLLERS}
      ZBX_STARTIPMIPOLLERS: ${ZBX_STARTIPMIPOLLERS}
      ZBX_STARTPOLLERSUNREACHABLE: ${ZBX_STARTPOLLERSUNREACHABLE}
      ZBX_STARTTRAPPERS: ${ZBX_STARTTRAPPERS}
      ZBX_STARTPINGERS: ${ZBX_STARTPINGERS}
      ZBX_STARTVMWARECOLLECTORS: ${ZBX_STARTVMWARECOLLECTORS}
      ZBX_STARTDISCOVERERS: ${ZBX_STARTDISCOVERERS}
      ZBX_STARTHTTPPOLLERS: ${ZBX_STARTHTTPPOLLERS}
      ZBX_STARTTIMERS: ${ZBX_STARTTIMERS}
      ZBX_STARTESCALATORS: ${ZBX_STARTESCALATORS}
      ZBX_STARTALERTERS: ${ZBX_STARTALERTERS}
      ZBX_TIMEOUT: ${ZBX_TIMEOUT}
      ZBX_LOGSLOWQUERIES: ${ZBX_LOGSLOWQUERIES}
      ZBX_STARTDBSYNCERS: ${ZBX_STARTDBSYNCERS}
      ZBX_HOUSEKEEPINGFREQUENCY: ${ZBX_HOUSEKEEPINGFREQUENCY}
      ZBX_MAXHOUSEKEEPERDELETE: ${ZBX_MAXHOUSEKEEPERDELETE}
      ZBX_NODEADDRESS: ${ZBX_NODEADDRESS}
      ZBX_HANODENAME: ${ZBX_HANODENAME}
    volumes:
      - alertscripts:/usr/lib/zabbix/alertscripts:ro
      - externalscripts:/usr/lib/zabbix/externalscripts:ro
    ports:
      - "10051:10051"
    depends_on:
      - zabbix-db
    networks:
      - zabbix-network
    healthcheck:
      test: ["CMD-SHELL", "zabbix_server -V >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  zabbix-db:
    image: timescale/timescaledb:2.19.3-pg14
    container_name: zabbix-db
    command: >
      postgres -c 'max_connections=1000'
               -c 'shared_preload_libraries=timescaledb'
               -c 'shared_buffers=8GB'
               -c 'effective_cache_size=20GB'
               -c 'work_mem=128MB'
               -c 'maintenance_work_mem=1GB'
               -c 'max_wal_size=8GB'
               -c 'checkpoint_completion_target=0.9'
               -c 'timescaledb.telemetry_level=off'
               -c 'timescaledb.max_background_workers=16'
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - database:/var/lib/postgresql/data:Z
    networks:
      - zabbix-network
      - pg_backup
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

volumes:
  alertscripts:
  externalscripts:
  database:

networks:
  zabbix-network:
    driver: bridge
  pg_backup:
    external: true